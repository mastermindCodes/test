<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>اختبار قرارات الحكام</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --font-family: 'Tahoma', sans-serif; /* خط بسيط وواضح */
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* منع التمرير */
            font-family: var(--font-family);
            background-color: var(--light-color);
            color: var(--dark-color);
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .container {
            width: 95%;
            max-width: 800px; /* حد أقصى للعرض */
            height: 95vh;     /* استخدام نسبة من ارتفاع الشاشة */
            max-height: 600px; /* حد أقصى للارتفاع */
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* توزيع المساحة */
            overflow: hidden; /* تأكيد عدم التمرير داخل الحاوية */
        }

        /* --- شاشة تسجيل الدخول --- */
        #login-view {
            display: flex; /* Use flex for centering */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%; /* Take full height of container */
        }

        #login-view h1 {
             margin-bottom: 30px;
             color: var(--primary-color);
        }

        .form-group {
            margin-bottom: 15px;
            width: 80%;
            max-width: 300px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box; /* لتضمين الحشو والإطار في العرض */
        }

        /* --- شاشة الاختبار --- */
        #test-view {
            display: none; /* مخفي افتراضيًا */
            flex-direction: column;
            height: 100%;
        }

        #video-container {
            position: relative;
            width: 100%;
            /* حساب الارتفاع لنسبة 16:9 مع ترك مساحة للعناصر الأخرى */
            height: 60vh; /* زيادة ارتفاع الفيديو لتعويض غياب الكاميرا */
            max-height: 400px; /* زيادة الحد الأقصى لارتفاع الفيديو */
            background-color: #000;
            margin-bottom: 15px;
        }

        #test-video {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: contain; /* للحفاظ على نسبة العرض إلى الارتفاع */
        }

        #controls {
            margin-bottom: 15px;
        }

        #options-container {
            display: flex;
            flex-wrap: wrap; /* للسماح بانتقال الأزرار لسطر جديد إذا لزم الأمر */
            justify-content: center;
            gap: 10px; /* مسافة بين الأزرار */
            margin-top: 15px;
        }

        /* --- شاشة النتائج --- */
        #results-view {
            display: none; /* مخفي افتراضيًا */
            flex-direction: column;
            align-items: center;
            height: 100%;
            overflow-y: auto; /* السماح بالتمرير إذا كانت النتائج كثيرة */
        }

         #results-view h2 {
            color: var(--primary-color);
             margin-bottom: 20px;
         }

        #results-summary {
            font-size: 1.1em;
            margin-bottom: 20px;
        }

        #results-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        #results-table th, #results-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        #results-table th {
            background-color: var(--secondary-color);
            color: white;
        }

         #results-table tr:nth-child(even){background-color: var(--light-color);}

        /* --- الأزرار والعناصر العامة --- */
        button {
            padding: 12px 25px;
            font-size: 1em;
            font-family: var(--font-family);
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            min-width: 100px; /* عرض أدنى للأزرار */
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: var(--secondary-color);
            cursor: not-allowed;
        }

        .option-button {
             background-color: var(--success-color);
        }
        .option-button:hover {
             background-color: #218838;
        }

        #stop-video-btn {
            background-color: var(--danger-color);
        }
        #stop-video-btn:hover {
            background-color: #c82333;
        }

        #status {
            margin-bottom: 10px;
            font-weight: bold;
            color: var(--secondary-color);
        }

        #error-message {
            color: var(--danger-color);
            margin-top: 10px;
            min-height: 1.2em; /* حجز مساحة لرسالة الخطأ */
        }

         /* تحسينات للشاشات الصغيرة واللمس */
         @media (max-width: 600px) {
            .container {
                width: 100%;
                height: 100vh;
                max-height: none;
                border-radius: 0;
                padding: 10px;
                 box-shadow: none;
            }
            #video-container {
                height: 55vh; /* تعديل الارتفاع للشاشات الأصغر */
                max-height: none;
                 margin-bottom: 10px;
            }
             button {
                 padding: 15px 20px; /* زيادة حجم الأزرار للمس */
                 font-size: 1.1em;
             }
             #options-container {
                 gap: 8px;
             }
             #results-view {
                 padding-bottom: 60px; /* مساحة إضافية في الأسفل لتجنب التغطية */
             }
         }

    </style>
</head>
<body>

    <div class="container">

        <!-- 1. شاشة تسجيل الدخول -->
        <div id="login-view">
            <h1>اختبار قرارات الحكام</h1>
            <div class="form-group">
                <label for="username">اسم المستخدم:</label>
                <input type="text" id="username" name="username">
            </div>
            <div class="form-group">
                <label for="password">كلمة المرور:</label>
                <input type="password" id="password" name="password">
            </div>
            <button id="login-btn">تسجيل الدخول</button>
            <div id="error-message"></div>
        </div>

        <!-- 2. شاشة الاختبار -->
        <div id="test-view">
            <div id="status">الحالة 1 من X</div>
            <div id="video-container">
                <video id="test-video" playsinline muted controlsList="nodownload nofullscreen noremoteplayback"></video>
                <!-- تم حذف عنصر الكاميرا -->
            </div>
            <div id="controls">
                <button id="stop-video-btn">إيقاف الفيديو</button>
            </div>
            <div id="options-container" style="visibility: hidden;">
                <!-- سيتم ملء الأزرار هنا بواسطة JavaScript -->
            </div>
        </div>

        <!-- 3. شاشة النتائج -->
        <div id="results-view">
            <h2>نتائج الاختبار</h2>
            <div id="results-summary"></div>
            <table id="results-table">
                <thead>
                    <tr>
                        <th>الحالة</th>
                        <th>القرار المتخذ</th>
                        <th>الإجابة الصحيحة</th>
                        <th>الوقت (ثانية)</th>
                        <th>النتيجة</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- سيتم ملء الصفوف هنا بواسطة JavaScript -->
                </tbody>
            </table>
            <button id="restart-btn">إعادة الاختبار</button>
             <button id="logout-btn" style="margin-top: 10px; background-color: var(--secondary-color);">تسجيل الخروج</button>
        </div>

    </div>

    <script>
        // --- العناصر ---
        const loginView = document.getElementById('login-view');
        const testView = document.getElementById('test-view');
        const resultsView = document.getElementById('results-view');
        const loginBtn = document.getElementById('login-btn');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const errorMessage = document.getElementById('error-message');
        const videoElement = document.getElementById('test-video');
        // تم حذف cameraPreviewElement
        const stopVideoBtn = document.getElementById('stop-video-btn');
        const optionsContainer = document.getElementById('options-container');
        const statusElement = document.getElementById('status');
        const resultsSummary = document.getElementById('results-summary');
        const resultsTableBody = document.querySelector('#results-table tbody');
        const restartBtn = document.getElementById('restart-btn');
        const logoutBtn = document.getElementById('logout-btn');


        // --- بيانات الاختبار (استخدم روابط فيديوهات حقيقية ومتاحة للعامة) ---
        const testCases = [
            {
                videoUrl: 'https://sample-videos.com/video123/mp4/720/big_buck_bunny_720p_1mb.mp4', // مثال قصير جداً
                options: ['خطأ بسيط', 'إنذار', 'طرد'],
                correctAnswer: 'إنذار'
            },
            {
                videoUrl: 'http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerBlazes.mp4', // فيديو أطول قليلاً
                options: ['لا يوجد خطأ', 'ضربة حرة مباشرة', 'ضربة جزاء', 'إنذار'],
                correctAnswer: 'ضربة حرة مباشرة'
            },
            {
                videoUrl: 'http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4', // فيديو مختلف
                options: ['تسلل', 'رمية تماس', 'هدف صحيح'],
                correctAnswer: 'تسلل'
            },
             {
                videoUrl: 'https://test-videos.co.uk/vids/bigbuckbunny/mp4/h264/360/Big_Buck_Bunny_360_10s_1MB.mp4', // مثال آخر قصير
                options: ['بطاقة صفراء', 'بطاقة حمراء', 'لا شيء'],
                correctAnswer: 'لا شيء'
            },
             {
                 // تأكد من أن هذا الرابط يعمل ومتاح
                 videoUrl: 'http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerEscapes.mp4',
                 options: ['خطأ', 'تمثيل', 'استمرار اللعب', 'ركلة ركنية'],
                 correctAnswer: 'استمرار اللعب'
             }
            // يمكنك إضافة المزيد من الحالات هنا
        ];

        // --- متغيرات حالة الاختبار ---
        let currentCaseIndex = 0;
        let decisionStartTime = 0;
        let results = [];
        // تم حذف متغيرات التسجيل والكاميرا (mediaRecorder, recordedChunks, screenStream, cameraStream)

        // --- وظائف ---

        // وظيفة للتبديل بين الشاشات
        function showView(viewId) {
            loginView.style.display = 'none';
            testView.style.display = 'none';
            resultsView.style.display = 'none';

            const viewToShow = document.getElementById(viewId);
            if (viewToShow) {
                // استخدام flex بدلاً من block للحفاظ على التنسيق
                viewToShow.style.display = 'flex';
            }
        }

        // تم حذف وظائف startRecordingAndCamera و stopStreams

        // تحميل وعرض الحالة (الفيديو)
        function loadCase(index) {
            if (index >= testCases.length) {
                showResults(); // انتهى الاختبار، اعرض النتائج مباشرة
                return;
            }

            const currentCase = testCases[index];
            statusElement.textContent = `الحالة ${index + 1} من ${testCases.length}`;
            videoElement.src = currentCase.videoUrl;
            videoElement.currentTime = 0; // البدء من البداية
            optionsContainer.innerHTML = ''; // مسح الخيارات القديمة
            optionsContainer.style.visibility = 'hidden'; // إخفاء الخيارات
            stopVideoBtn.disabled = false; // تمكين زر الإيقاف
            stopVideoBtn.style.display = 'inline-block'; // إظهار زر الإيقاف

            // محاولة تشغيل الفيديو تلقائياً
            videoElement.play().catch(error => {
                console.warn("Autoplay failed:", error);
                // قد تحتاج المتصفحات الحديثة إلى تفاعل المستخدم لبدء الفيديو
                 statusElement.textContent += " (اضغط على الفيديو للبدء إذا لم يعمل)";
                 // نضيف مستمع نقرة واحد لتشغيل الفيديو إذا فشل التشغيل التلقائي
                const playHandler = () => {
                    videoElement.play();
                    videoElement.removeEventListener('click', playHandler); // نزيل المستمع بعد أول نقرة ناجحة
                    videoElement.removeEventListener('touchstart', playHandler); // نزيل المستمع بعد أول لمسة ناجحة
                };
                videoElement.addEventListener('click', playHandler);
                 videoElement.addEventListener('touchstart', playHandler); // لدعم اللمس
            });
        }

        // التعامل مع إيقاف الفيديو
        function handleStopVideo() {
            videoElement.pause();
            decisionStartTime = performance.now(); // بدء حساب الوقت
            stopVideoBtn.disabled = true; // تعطيل الزر بعد الضغط
            stopVideoBtn.style.display = 'none'; // إخفاء زر الإيقاف

            // عرض الخيارات
            const currentCase = testCases[currentCaseIndex];
            optionsContainer.innerHTML = ''; // تأكيد مسح الخيارات
            currentCase.options.forEach(optionText => {
                const button = document.createElement('button');
                button.textContent = optionText;
                button.classList.add('option-button');
                button.onclick = () => handleOptionSelect(optionText);
                optionsContainer.appendChild(button);
            });
            optionsContainer.style.visibility = 'visible'; // إظهار الخيارات
        }

        // التعامل مع اختيار خيار
        function handleOptionSelect(selectedOption) {
            const decisionEndTime = performance.now();
            const decisionTime = ((decisionEndTime - decisionStartTime) / 1000).toFixed(2); // بالثواني
            const currentCase = testCases[currentCaseIndex];
            const isCorrect = selectedOption === currentCase.correctAnswer;

            // تخزين النتيجة
            results.push({
                caseIndex: currentCaseIndex + 1,
                selected: selectedOption,
                correct: currentCase.correctAnswer,
                time: decisionTime,
                isCorrect: isCorrect
            });

            // الانتقال للحالة التالية
            currentCaseIndex++;
            loadCase(currentCaseIndex);
        }

         // عرض النتائج (لم يعد بحاجة لإيقاف التدفقات)
        function showResults() {
            displayResults();
            showView('results-view');
        }

        // عرض النتائج النهائية في الجدول والملخص
        function displayResults() {
            resultsTableBody.innerHTML = ''; // مسح النتائج القديمة
            let correctCount = 0;
            let totalTime = 0;

            results.forEach(result => {
                const row = resultsTableBody.insertRow();
                row.insertCell(0).textContent = result.caseIndex;
                row.insertCell(1).textContent = result.selected;
                row.insertCell(2).textContent = result.correct;
                row.insertCell(3).textContent = result.time;
                const statusCell = row.insertCell(4);
                statusCell.textContent = result.isCorrect ? 'صحيح' : 'خطأ';
                statusCell.style.color = result.isCorrect ? 'var(--success-color)' : 'var(--danger-color)';
                statusCell.style.fontWeight = 'bold';

                if (result.isCorrect) {
                    correctCount++;
                }
                totalTime += parseFloat(result.time);
            });

            const accuracy = results.length > 0 ? ((correctCount / results.length) * 100).toFixed(1) : 0;
            const averageTime = results.length > 0 ? (totalTime / results.length).toFixed(2) : 0;

            resultsSummary.innerHTML = `
                الإجمالي: ${correctCount} إجابات صحيحة من ${results.length} حالة.<br>
                الدقة: ${accuracy}%<br>
                متوسط وقت القرار: ${averageTime} ثانية.
            `;
        }

        // إعادة بدء الاختبار
        function restartTest() {
            currentCaseIndex = 0;
            results = [];
            resultsTableBody.innerHTML = '';
            resultsSummary.innerHTML = '';
            errorMessage.textContent = ''; // مسح رسائل الخطأ
            // لا حاجة لبدء التسجيل/الكاميرا، فقط تحميل الحالة الأولى
            loadCase(currentCaseIndex);
            showView('test-view');
        }

        // تسجيل الخروج
        function logout() {
            // لا حاجة لإيقاف التدفقات
            usernameInput.value = '';
            passwordInput.value = '';
            errorMessage.textContent = '';
            currentCaseIndex = 0;
            results = [];
            resultsTableBody.innerHTML = '';
            resultsSummary.innerHTML = '';
            // التأكد من إيقاف الفيديو إذا كان يعمل عند تسجيل الخروج من شاشة الاختبار (احتياطي)
            if (!videoElement.paused) {
                videoElement.pause();
            }
            videoElement.src = ''; // إزالة مصدر الفيديو
            showView('login-view');
        }


        // --- ربط الأحداث ---
        loginBtn.addEventListener('click', () => {
            const username = usernameInput.value.trim();
            const password = passwordInput.value;

            // تحقق بسيط جدًا
            if (username === 'admin' && password === 'admin') {
                errorMessage.textContent = '';
                console.log("Login successful.");
                // إعادة تعيين وبدء الاختبار مباشرة
                currentCaseIndex = 0;
                results = [];
                loadCase(currentCaseIndex);
                showView('test-view');

            } else {
                errorMessage.textContent = 'اسم المستخدم أو كلمة المرور غير صحيحة.';
            }
        });

        stopVideoBtn.addEventListener('click', handleStopVideo);
        restartBtn.addEventListener('click', restartTest);
        logoutBtn.addEventListener('click', logout);

        // --- التهيئة الأولية ---
        showView('login-view'); // البدء بشاشة تسجيل الدخول

         // (اختياري) يمكنك إبقاء التحذير عند محاولة إغلاق الصفحة أثناء الاختبار
         window.addEventListener('beforeunload', (event) => {
             // التحقق مما إذا كان الاختبار قيد التقدم (في شاشة الاختبار)
             if (testView.style.display === 'flex') {
                 // رسالة التحذير القياسية
                 event.preventDefault(); // مطلوب لبعض المتصفحات
                 event.returnValue = ''; // مطلوب لمعظم المتصفحات الحديثة
             }
         });

    </script>

</body>
</html>
